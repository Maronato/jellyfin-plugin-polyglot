<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Multi-Language Library</title>
</head>
<body>
    <div id="multiLangConfigPage" data-role="page" class="page type-interior pluginConfigurationPage" data-require="emby-input,emby-button,emby-select,emby-checkbox,emby-collapse">
        <div data-role="content">
            <div class="content-primary">
                <h2>Multi-Language Library</h2>
                <p class="fieldDescription">Create language-specific library mirrors with hardlinked media files and separate metadata.</p>

                <!-- Warning Banner -->
                <div class="paperList" style="background: #5c3d00; border: 1px solid #cc7700; margin-bottom: 1em;">
                    <div class="listItem">
                        <div class="listItemBody">
                            <h3 class="listItemBodyText" style="color: #ffcc00;">⚠️ Watch History Warning</h3>
                            <div class="fieldDescription">Changing a user's language assignment will make their watch history appear "reset" because each library has unique item IDs. The original progress is preserved in the original library.</div>
                    </div>
                </div>
            </div>

                <!-- Tabs -->
                <div class="tabs-viewmenubar" style="margin-bottom: 2em;">
                    <button is="emby-button" class="emby-tab-button emby-button-tab active" data-tab="languagesTab">Languages</button>
                    <button is="emby-button" class="emby-tab-button emby-button-tab" data-tab="usersTab">Users</button>
                    <button is="emby-button" class="emby-tab-button emby-button-tab" data-tab="ldapTab">LDAP</button>
                    <button is="emby-button" class="emby-tab-button emby-button-tab" data-tab="settingsTab">Settings</button>
                </div>

                <!-- Languages Tab -->
                <div id="languagesTab" class="tabContent active">
                    <div class="verticalSection">
                        <h3 class="sectionTitle">Existing Jellyfin Libraries</h3>
                        <div id="librariesList" class="paperList"></div>
            </div>

                    <div class="verticalSection">
                        <div class="sectionTitleContainer flex align-items-center">
                            <h3 class="sectionTitle">Language Alternatives</h3>
                            <button is="emby-button" type="button" class="fab submit" id="btnAddAlternative" style="margin-left: auto;">
                                <span class="material-icons add"></span>
                            </button>
                        </div>
                        <div id="alternativesList" class="paperList"></div>
                    </div>
                </div>

                <!-- Users Tab -->
                <div id="usersTab" class="tabContent" style="display: none;">
                    <div class="verticalSection">
                        <h3 class="sectionTitle">User Language Assignments</h3>
                        <div id="usersList" class="paperList"></div>
                </div>
            </div>

                <!-- LDAP Tab -->
                <div id="ldapTab" class="tabContent" style="display: none;">
                    <div class="verticalSection">
                        <h3 class="sectionTitle">LDAP Status</h3>
                        <div id="ldapStatus" class="paperList"></div>
                    </div>

                    <div class="verticalSection">
                        <div class="sectionTitleContainer flex align-items-center">
                            <h3 class="sectionTitle">Group Mappings</h3>
                            <button is="emby-button" type="button" class="fab submit" id="btnAddLdapMapping" style="margin-left: auto;">
                                <span class="material-icons add"></span>
                            </button>
                        </div>
                        <div id="ldapMappingsList" class="paperList"></div>
                    </div>

                    <div class="verticalSection">
                        <button is="emby-button" type="button" class="raised" id="btnTestLdap">
                            <span>Test LDAP Connection</span>
                        </button>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settingsTab" class="tabContent" style="display: none;">
                    <form id="settingsForm">
                        <div class="verticalSection">
                            <h3 class="sectionTitle">Sync Settings</h3>
                            
                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="syncDisplayLanguage" type="checkbox" is="emby-checkbox" />
                                    <span>Sync Display Language</span>
                                </label>
                                <div class="fieldDescription">Update user's Jellyfin UI language when their plugin language changes.</div>
                            </div>

                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="syncSubtitleLanguage" type="checkbox" is="emby-checkbox" />
                                    <span>Sync Subtitle Language</span>
                                </label>
                                <div class="fieldDescription">Update user's preferred subtitle language.</div>
                            </div>

                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="syncAudioLanguage" type="checkbox" is="emby-checkbox" />
                                    <span>Sync Audio Language</span>
                        </label>
                                <div class="fieldDescription">Update user's preferred audio language.</div>
                    </div>

                            <div class="checkboxContainer checkboxContainer-withDescription">
                                <label class="emby-checkbox-label">
                                    <input id="enableLdapIntegration" type="checkbox" is="emby-checkbox" />
                                    <span>Enable LDAP Integration</span>
                                </label>
                                <div class="fieldDescription">Automatically assign languages based on LDAP group membership.</div>
                </div>

                            <div class="inputContainer">
                                <label class="inputLabel inputLabelUnfocused" for="mirrorSyncInterval">Mirror Sync Interval (hours)</label>
                                <input id="mirrorSyncInterval" type="number" is="emby-input" min="1" value="6" />
                                <div class="fieldDescription">How often to sync mirror libraries with source libraries.</div>
                    </div>
                </div>

                        <div>
                            <button is="emby-button" type="submit" class="raised button-submit block emby-button">
                                <span>Save Settings</span>
                            </button>
                        </div>
                    </form>
                </div>

            </div>
        </div>

        <!-- Add Alternative Dialog -->
        <div id="addAlternativeDialog" class="dialog hide" style="display: none;">
            <div class="dialogContent">
                <h3>Add Language Alternative</h3>
                <form id="addAlternativeForm">
                    <div class="inputContainer">
                        <label class="inputLabel" for="altName">Name</label>
                        <input id="altName" type="text" is="emby-input" required />
                        <div class="fieldDescription">Display name (e.g., "Portuguese")</div>
                    </div>
                    <div class="inputContainer">
                        <label class="inputLabel" for="altLanguageCode">Language Code</label>
                        <input id="altLanguageCode" type="text" is="emby-input" required placeholder="pt-BR" />
                        <div class="fieldDescription">Locale code for metadata (e.g., "pt-BR", "es-ES")</div>
                </div>
                    <div class="inputContainer">
                        <label class="inputLabel" for="altMetadataLang">Metadata Language</label>
                        <input id="altMetadataLang" type="text" is="emby-input" placeholder="pt" />
                        <div class="fieldDescription">Two-letter language code (e.g., "pt", "es")</div>
                </div>
                    <div class="inputContainer">
                        <label class="inputLabel" for="altMetadataCountry">Metadata Country</label>
                        <input id="altMetadataCountry" type="text" is="emby-input" placeholder="BR" />
                        <div class="fieldDescription">Two-letter country code (e.g., "BR", "ES")</div>
                </div>
                    <div class="formDialogFooter">
                        <button is="emby-button" type="button" class="raised button-cancel" onclick="MultiLangConfig.closeDialog('addAlternativeDialog')">Cancel</button>
                        <button is="emby-button" type="submit" class="raised button-submit">Create</button>
                </div>
                </form>
            </div>
        </div>

        <!-- Add Mirror Dialog -->
        <div id="addMirrorDialog" class="dialog hide" style="display: none;">
            <div class="dialogContent">
                <h3>Add Library Mirror</h3>
                <form id="addMirrorForm">
                    <input type="hidden" id="mirrorAlternativeId" />
                    <div class="selectContainer">
                        <label class="selectLabel" for="mirrorSourceLibrary">Source Library</label>
                        <select id="mirrorSourceLibrary" is="emby-select"></select>
                </div>
                    <div class="inputContainer">
                        <label class="inputLabel" for="mirrorTargetPath">Target Path</label>
                        <input id="mirrorTargetPath" type="text" is="emby-input" required placeholder="/media/mirrors/portuguese/movies" />
                        <div class="fieldDescription">Path where mirrored files will be created (must be on same filesystem as source)</div>
                </div>
                    <div class="inputContainer">
                        <label class="inputLabel" for="mirrorTargetName">Library Name (optional)</label>
                        <input id="mirrorTargetName" type="text" is="emby-input" placeholder="Movies (Portuguese)" />
                        <div class="fieldDescription">Name for the new Jellyfin library</div>
                </div>
                    <div class="formDialogFooter">
                        <button is="emby-button" type="button" class="raised button-cancel" onclick="MultiLangConfig.closeDialog('addMirrorDialog')">Cancel</button>
                        <button is="emby-button" type="submit" class="raised button-submit">Create Mirror</button>
                </div>
                </form>
            </div>
        </div>

        <!-- Add LDAP Mapping Dialog -->
        <div id="addLdapMappingDialog" class="dialog hide" style="display: none;">
            <div class="dialogContent">
                <h3>Add LDAP Group Mapping</h3>
                <form id="addLdapMappingForm">
                    <div class="inputContainer">
                        <label class="inputLabel" for="ldapGroupDn">Group DN</label>
                        <input id="ldapGroupDn" type="text" is="emby-input" required placeholder="CN=Portuguese Users,OU=Groups,DC=example,DC=com" />
                </div>
                    <div class="inputContainer">
                        <label class="inputLabel" for="ldapGroupName">Group Name (optional)</label>
                        <input id="ldapGroupName" type="text" is="emby-input" placeholder="Portuguese Users" />
                        <div class="fieldDescription">Friendly name, also used for CN matching</div>
                </div>
                    <div class="selectContainer">
                        <label class="selectLabel" for="ldapLanguageAlt">Language Alternative</label>
                        <select id="ldapLanguageAlt" is="emby-select"></select>
                </div>
                    <div class="inputContainer">
                        <label class="inputLabel" for="ldapPriority">Priority</label>
                        <input id="ldapPriority" type="number" is="emby-input" value="0" />
                        <div class="fieldDescription">Higher priority wins when user is in multiple groups</div>
                </div>
                    <div class="formDialogFooter">
                        <button is="emby-button" type="button" class="raised button-cancel" onclick="MultiLangConfig.closeDialog('addLdapMappingDialog')">Cancel</button>
                        <button is="emby-button" type="submit" class="raised button-submit">Create Mapping</button>
                </div>
                </form>
        </div>
    </div>

        <script type="text/javascript">
            var MultiLangConfig = {
                pluginUniqueId: 'a1b2c3d4-e5f6-7890-abcd-ef1234567890',
                alternatives: [],
                libraries: [],
                users: [],

                // Custom API helpers for plugin-specific endpoints
                apiGet: function(endpoint) {
                    return ApiClient.getJSON(ApiClient.getUrl(endpoint));
                },

                apiPost: function(endpoint, data) {
                    return ApiClient.fetch({
                        url: ApiClient.getUrl(endpoint),
                        type: 'POST',
                        data: JSON.stringify(data),
                        contentType: 'application/json'
                    });
                },

                apiPut: function(endpoint, data) {
                    return ApiClient.fetch({
                        url: ApiClient.getUrl(endpoint),
                        type: 'PUT',
                        data: JSON.stringify(data),
                        contentType: 'application/json'
                    });
                },

                apiDelete: function(endpoint) {
                    return ApiClient.fetch({
                        url: ApiClient.getUrl(endpoint),
                        type: 'DELETE'
                    });
                },

                // Tab switching
                switchTab: function(tabId) {
                    document.querySelectorAll('.tabContent').forEach(function(tab) {
                        tab.style.display = 'none';
                        tab.classList.remove('active');
                    });
                    document.querySelectorAll('.emby-tab-button').forEach(function(btn) {
                        btn.classList.remove('active');
                    });
                    document.getElementById(tabId).style.display = 'block';
                    document.getElementById(tabId).classList.add('active');
                    document.querySelector('[data-tab="' + tabId + '"]').classList.add('active');
                },

                // Dialog helpers
                showDialog: function(dialogId) {
                    var dialog = document.getElementById(dialogId);
                    dialog.style.display = 'flex';
                    dialog.classList.remove('hide');
                },

                closeDialog: function(dialogId) {
                    var dialog = document.getElementById(dialogId);
                    dialog.style.display = 'none';
                    dialog.classList.add('hide');
                },

                // Load data
                loadLibraries: function() {
                    var self = this;
                    Dashboard.showLoadingMsg();
                    // Use built-in ApiClient method for libraries, enhanced with our plugin data
                    Promise.all([
                        ApiClient.getVirtualFolders(),
                        ApiClient.getPluginConfiguration(this.pluginUniqueId)
                    ]).then(function(results) {
                        var folders = results[0];
                        var config = results[1];
                        
                        // Build set of mirror library IDs
                        var mirrorIds = new Set();
                        if (config.LanguageAlternatives) {
                            config.LanguageAlternatives.forEach(function(alt) {
                                if (alt.MirroredLibraries) {
                                    alt.MirroredLibraries.forEach(function(m) {
                                        if (m.TargetLibraryId) mirrorIds.add(m.TargetLibraryId);
                                    });
                                }
                            });
                        }
                        
                        self.libraries = folders.map(function(folder) {
                            return {
                                Id: folder.ItemId,
                                Name: folder.Name,
                                CollectionType: folder.CollectionType,
                                PreferredMetadataLanguage: folder.LibraryOptions ? folder.LibraryOptions.PreferredMetadataLanguage : null,
                                IsMirror: mirrorIds.has(folder.ItemId)
                            };
                        });
                        
                        var html = '';
                        self.libraries.forEach(function(lib) {
                            html += '<div class="listItem">';
                            html += '<div class="listItemBody">';
                            html += '<div class="listItemBodyText">' + lib.Name + '</div>';
                            html += '<div class="listItemBodyText secondary">' + (lib.CollectionType || 'mixed') + ' • ' + (lib.PreferredMetadataLanguage || 'default') + '</div>';
                            html += '</div>';
                            if (lib.IsMirror) {
                                html += '<span class="material-icons" style="color: #00a4dc;">content_copy</span>';
                            }
                            html += '</div>';
                        });
                        document.getElementById('librariesList').innerHTML = html || '<p class="fieldDescription">No libraries found.</p>';
                        Dashboard.hideLoadingMsg();
                    });
                },

                loadAlternatives: function() {
                    var self = this;
                    // Use built-in ApiClient method for plugin configuration
                    ApiClient.getPluginConfiguration(this.pluginUniqueId).then(function(config) {
                        self.alternatives = config.LanguageAlternatives || [];
                        var html = '';
                        self.alternatives.forEach(function(alt) {
                            html += '<div class="listItem" style="flex-wrap: wrap;">';
                            html += '<div class="listItemBody" style="flex: 1;">';
                            html += '<div class="listItemBodyText">' + alt.Name + ' (' + alt.LanguageCode + ')</div>';
                            html += '<div class="listItemBodyText secondary">Metadata: ' + (alt.MetadataLanguage || 'auto') + '-' + (alt.MetadataCountry || 'auto') + '</div>';
                            html += '</div>';
                            html += '<button is="emby-button" type="button" class="fab" onclick="MultiLangConfig.showAddMirrorDialog(\'' + alt.Id + '\')"><span class="material-icons add"></span></button>';
                            html += '<button is="emby-button" type="button" class="fab" onclick="MultiLangConfig.syncAlternative(\'' + alt.Id + '\')"><span class="material-icons sync"></span></button>';
                            html += '<button is="emby-button" type="button" class="fab" onclick="MultiLangConfig.deleteAlternative(\'' + alt.Id + '\')"><span class="material-icons delete"></span></button>';
                            
                            // Show mirrors
                            if (alt.MirroredLibraries && alt.MirroredLibraries.length > 0) {
                                html += '<div style="width: 100%; padding-left: 1em; margin-top: 0.5em;">';
                                alt.MirroredLibraries.forEach(function(mirror) {
                                    html += '<div class="listItem" style="background: rgba(0,0,0,0.2);">';
                                    html += '<span class="material-icons">subdirectory_arrow_right</span>';
                                    html += '<div class="listItemBody">';
                                    html += '<div class="listItemBodyText">' + mirror.SourceLibraryName + ' → ' + mirror.TargetLibraryName + '</div>';
                                    html += '<div class="listItemBodyText secondary">' + mirror.Status + (mirror.LastSyncedAt ? ' • Last sync: ' + new Date(mirror.LastSyncedAt).toLocaleString() : '') + '</div>';
                                    html += '</div>';
                                    html += '</div>';
                                });
                                html += '</div>';
                            }
                            html += '</div>';
                        });
                        document.getElementById('alternativesList').innerHTML = html || '<p class="fieldDescription">No language alternatives configured. Click + to add one.</p>';
                    });
                },

                loadUsers: function() {
                    var self = this;
                    // Use built-in ApiClient.getUsers() and merge with plugin config
                    Promise.all([
                        ApiClient.getUsers(),
                        ApiClient.getPluginConfiguration(this.pluginUniqueId)
                    ]).then(function(results) {
                        var jellyfinUsers = results[0];
                        var config = results[1];
                        // Convert UserLanguages array to a lookup object by UserId
                        var userLanguagesArray = config.UserLanguages || [];
                        var userLanguages = {};
                        userLanguagesArray.forEach(function(ul) {
                            userLanguages[ul.UserId] = ul;
                        });
                        
                        self.users = jellyfinUsers.map(function(user) {
                            var langConfig = userLanguages[user.Id];
                            var altName = null;
                            if (langConfig && langConfig.SelectedAlternativeId) {
                                var alt = self.alternatives.find(function(a) { return a.Id === langConfig.SelectedAlternativeId; });
                                if (alt) altName = alt.Name;
                            }
                            return {
                                Id: user.Id,
                                Username: user.Name,
                                IsAdministrator: user.Policy && user.Policy.IsAdministrator,
                                AssignedAlternativeId: langConfig ? langConfig.SelectedAlternativeId : null,
                                AssignedAlternativeName: altName,
                                ManuallySet: langConfig ? langConfig.ManuallySet : false
                            };
                        });
                        
                        var html = '';
                        self.users.forEach(function(user) {
                            html += '<div class="listItem">';
                            html += '<div class="listItemBody" style="flex: 1;">';
                            html += '<div class="listItemBodyText">' + user.Username + (user.IsAdministrator ? ' (Admin)' : '') + '</div>';
                            html += '<div class="listItemBodyText secondary">' + (user.AssignedAlternativeName || 'No language assigned') + (user.ManuallySet ? ' (manual)' : '') + '</div>';
                            html += '</div>';
                            html += '<select is="emby-select" onchange="MultiLangConfig.setUserLanguage(\'' + user.Id + '\', this.value)" style="width: auto;">';
                            html += '<option value="">-- None --</option>';
                            self.alternatives.forEach(function(alt) {
                                html += '<option value="' + alt.Id + '"' + (user.AssignedAlternativeId === alt.Id ? ' selected' : '') + '>' + alt.Name + '</option>';
                            });
                            html += '</select>';
                            html += '</div>';
                        });
                        document.getElementById('usersList').innerHTML = html || '<p class="fieldDescription">No users found.</p>';
                    });
                },

                loadLdapStatus: function() {
                    this.apiGet('MultiLang/LdapStatus').then(function(status) {
                        var html = '<div class="listItem"><div class="listItemBody">';
                        html += '<div class="listItemBodyText">LDAP Plugin: ' + (status.IsPluginInstalled ? '✓ Installed' : '✗ Not installed') + '</div>';
                        html += '<div class="listItemBodyText secondary">';
                        html += 'Configured: ' + (status.IsConfigured ? '✓' : '✗');
                        html += ' • Integration: ' + (status.IsIntegrationEnabled ? '✓ Enabled' : '✗ Disabled');
                        if (status.ServerAddress) html += ' • Server: ' + status.ServerAddress;
                        html += '</div>';
                        html += '</div></div>';
                        document.getElementById('ldapStatus').innerHTML = html;
                    });
                },

                loadLdapMappings: function() {
                    var self = this;
                    // Use built-in ApiClient method for plugin configuration
                    ApiClient.getPluginConfiguration(this.pluginUniqueId).then(function(config) {
                        var mappings = config.LdapGroupMappings || [];
                        var html = '';
                        mappings.forEach(function(mapping) {
                            var altName = 'Unknown';
                            self.alternatives.forEach(function(alt) {
                                if (alt.Id === mapping.LanguageAlternativeId) altName = alt.Name;
                            });
                            html += '<div class="listItem">';
                            html += '<div class="listItemBody" style="flex: 1;">';
                            html += '<div class="listItemBodyText">' + (mapping.LdapGroupName || mapping.LdapGroupDn) + '</div>';
                            html += '<div class="listItemBodyText secondary">→ ' + altName + ' (Priority: ' + mapping.Priority + ')</div>';
                            html += '</div>';
                            html += '<button is="emby-button" type="button" class="fab" onclick="MultiLangConfig.deleteLdapMapping(\'' + mapping.LdapGroupDn + '\')"><span class="material-icons delete"></span></button>';
                            html += '</div>';
                        });
                        document.getElementById('ldapMappingsList').innerHTML = html || '<p class="fieldDescription">No LDAP group mappings configured.</p>';
                    });
                },

                loadSettings: function() {
                    var self = this;
                    // Use built-in ApiClient method for plugin configuration
                    ApiClient.getPluginConfiguration(this.pluginUniqueId).then(function(config) {
                        document.getElementById('syncDisplayLanguage').checked = config.SyncUserDisplayLanguage;
                        document.getElementById('syncSubtitleLanguage').checked = config.SyncUserSubtitleLanguage;
                        document.getElementById('syncAudioLanguage').checked = config.SyncUserAudioLanguage;
                        document.getElementById('enableLdapIntegration').checked = config.EnableLdapIntegration;
                        document.getElementById('mirrorSyncInterval').value = config.MirrorSyncIntervalHours || 6;
                    });
                },

        // Actions
                showAddMirrorDialog: function(altId) {
                    var self = this;
                    document.getElementById('mirrorAlternativeId').value = altId;
                    var select = document.getElementById('mirrorSourceLibrary');
                    select.innerHTML = '';
                    this.libraries.filter(function(lib) { return !lib.IsMirror; }).forEach(function(lib) {
                        select.innerHTML += '<option value="' + lib.Id + '">' + lib.Name + '</option>';
                    });
                    this.showDialog('addMirrorDialog');
                },

                createAlternative: function() {
                    var self = this;
                    var data = {
                        Name: document.getElementById('altName').value,
                        LanguageCode: document.getElementById('altLanguageCode').value,
                        MetadataLanguage: document.getElementById('altMetadataLang').value || null,
                        MetadataCountry: document.getElementById('altMetadataCountry').value || null
                    };
                    Dashboard.showLoadingMsg();
                    this.apiPost('MultiLang/Alternatives', data).then(function() {
                        self.closeDialog('addAlternativeDialog');
                        self.loadAlternatives();
                        Dashboard.hideLoadingMsg();
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to create alternative: ' + e.message);
                    });
                },

                createMirror: function() {
                    var self = this;
                    var altId = document.getElementById('mirrorAlternativeId').value;
                    var data = {
                        SourceLibraryId: document.getElementById('mirrorSourceLibrary').value,
                        TargetPath: document.getElementById('mirrorTargetPath').value,
                        TargetLibraryName: document.getElementById('mirrorTargetName').value || null
                    };
                    Dashboard.showLoadingMsg();
                    this.apiPost('MultiLang/Alternatives/' + altId + '/Libraries', data).then(function() {
                        self.closeDialog('addMirrorDialog');
                        self.loadAlternatives();
                        self.loadLibraries();
                        Dashboard.hideLoadingMsg();
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to create mirror: ' + e.message);
                    });
                },

                syncAlternative: function(altId) {
                    Dashboard.showLoadingMsg();
                    this.apiPost('MultiLang/Alternatives/' + altId + '/Sync', {}).then(function() {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Sync started. Check the scheduled tasks for progress.');
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to start sync: ' + e.message);
                    });
                },

                deleteAlternative: function(altId) {
                    var self = this;
                    Dashboard.confirm('Delete this language alternative and all its mirrors?', 'Confirm Delete', function(result) {
                        if (result) {
                            Dashboard.showLoadingMsg();
                            self.apiDelete('MultiLang/Alternatives/' + altId + '?deleteLibraries=true&deleteFiles=true').then(function() {
                                self.loadAlternatives();
                                self.loadLibraries();
                                Dashboard.hideLoadingMsg();
                            });
                        }
                    });
                },

                setUserLanguage: function(userId, altId) {
                    var self = this;
                    Dashboard.showLoadingMsg();
                    this.apiPut('MultiLang/Users/' + userId + '/Language', {
                        LanguageAlternativeId: altId || null,
                    ManuallySet: true
                    }).then(function() {
                        self.loadUsers();
                        Dashboard.hideLoadingMsg();
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to set user language: ' + e.message);
                    });
                },

                createLdapMapping: function() {
                    var self = this;
                    var data = {
                        LdapGroupDn: document.getElementById('ldapGroupDn').value,
                        LdapGroupName: document.getElementById('ldapGroupName').value || null,
                        LanguageAlternativeId: document.getElementById('ldapLanguageAlt').value,
                        Priority: parseInt(document.getElementById('ldapPriority').value) || 0
                    };
                    Dashboard.showLoadingMsg();
                    this.apiPost('MultiLang/LdapGroups', data).then(function() {
                        self.closeDialog('addLdapMappingDialog');
                        self.loadLdapMappings();
                        Dashboard.hideLoadingMsg();
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to create LDAP mapping: ' + e.message);
                    });
                },

                deleteLdapMapping: function(groupDn) {
                    var self = this;
                    Dashboard.showLoadingMsg();
                    this.apiDelete('MultiLang/LdapGroups/' + encodeURIComponent(groupDn)).then(function() {
                        self.loadLdapMappings();
                        Dashboard.hideLoadingMsg();
                    });
                },

                testLdapConnection: function() {
                    var username = prompt('Enter username to test (optional):');
                    Dashboard.showLoadingMsg();
                    this.apiPost('MultiLang/TestLdap', { Username: username || null }).then(function(result) {
                        Dashboard.hideLoadingMsg();
                        var msg = result.Message;
                        if (result.UserGroups && result.UserGroups.length > 0) {
                            msg += '\n\nGroups: ' + result.UserGroups.join(', ');
                        }
                        if (result.MatchedLanguage) {
                            msg += '\n\nMatched Language: ' + result.MatchedLanguage;
                        }
                        Dashboard.alert(msg);
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('LDAP test failed: ' + e.message);
                    });
                },

                saveSettings: function() {
                    var self = this;
                    Dashboard.showLoadingMsg();
                    // Use built-in ApiClient method for plugin configuration
                    ApiClient.getPluginConfiguration(this.pluginUniqueId).then(function(config) {
                        // Update only the settings fields
                        config.SyncUserDisplayLanguage = document.getElementById('syncDisplayLanguage').checked;
                        config.SyncUserSubtitleLanguage = document.getElementById('syncSubtitleLanguage').checked;
                        config.SyncUserAudioLanguage = document.getElementById('syncAudioLanguage').checked;
                        config.EnableLdapIntegration = document.getElementById('enableLdapIntegration').checked;
                        config.MirrorSyncIntervalHours = parseInt(document.getElementById('mirrorSyncInterval').value) || 6;
                        
                        return ApiClient.updatePluginConfiguration(self.pluginUniqueId, config);
                    }).then(function() {
                        Dashboard.hideLoadingMsg();
                        Dashboard.processPluginConfigurationUpdateResult();
                        self.loadLdapStatus();
                    }).catch(function(e) {
                        Dashboard.hideLoadingMsg();
                        Dashboard.alert('Failed to save settings: ' + e.message);
                    });
                },

                init: function() {
                    var self = this;
                    
                    // Load all data
                    this.loadLibraries();
                    this.loadAlternatives();
                    this.loadUsers();
                    this.loadLdapStatus();
                    this.loadLdapMappings();
                    this.loadSettings();

                    // Tab buttons
                    document.querySelectorAll('.emby-tab-button').forEach(function(btn) {
                        btn.addEventListener('click', function() {
                            self.switchTab(this.getAttribute('data-tab'));
                        });
                    });

                    // Add alternative button
                    document.getElementById('btnAddAlternative').addEventListener('click', function() {
                        self.showDialog('addAlternativeDialog');
                    });

                    // Add LDAP mapping button
                    document.getElementById('btnAddLdapMapping').addEventListener('click', function() {
                        var select = document.getElementById('ldapLanguageAlt');
                        select.innerHTML = '';
                        self.alternatives.forEach(function(alt) {
                            select.innerHTML += '<option value="' + alt.Id + '">' + alt.Name + '</option>';
                        });
                        self.showDialog('addLdapMappingDialog');
                    });

                    // Test LDAP button
                    document.getElementById('btnTestLdap').addEventListener('click', function() {
                        self.testLdapConnection();
                    });

                    // Form submissions
                    document.getElementById('addAlternativeForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        self.createAlternative();
                    });

                    document.getElementById('addMirrorForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        self.createMirror();
                    });

                    document.getElementById('addLdapMappingForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        self.createLdapMapping();
                    });

                    document.getElementById('settingsForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        self.saveSettings();
                    });
                }
            };

            document.getElementById('multiLangConfigPage').addEventListener('pageshow', function() {
                MultiLangConfig.init();
        });
    </script>

        <style type="text/css">
            .dialog {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
            }
            .dialog.hide {
                display: none !important;
            }
            .dialogContent {
                background: #1a1a1a;
                padding: 2em;
                border-radius: 8px;
                min-width: 400px;
                max-width: 90%;
                max-height: 90%;
                overflow-y: auto;
            }
            .formDialogFooter {
                display: flex;
                justify-content: flex-end;
                gap: 1em;
                margin-top: 1.5em;
            }
            .tabContent {
                min-height: 200px;
            }
        </style>
    </div>
</body>
</html>
